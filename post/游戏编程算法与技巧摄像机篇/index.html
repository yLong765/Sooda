<!DOCTYPE html>
<html lang="cn">

<head>


<meta charset="utf-8" />
<meta name="author" content="Alaya" />
<meta name="description" content="简简单单生活，安安静静编程" />
<meta name="keywords" content="" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.100.2" />

<link rel="canonical" href="https://sooda.net.cn/post/%E6%B8%B8%E6%88%8F%E7%BC%96%E7%A8%8B%E7%AE%97%E6%B3%95%E4%B8%8E%E6%8A%80%E5%B7%A7%E6%91%84%E5%83%8F%E6%9C%BA%E7%AF%87/">
<meta property="og:title" content="《游戏编程算法与技巧》摄像机篇" />
<meta property="og:description" content="此篇主要介绍摄像机涵盖的属性和一些摄像机跟随的写法" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sooda.net.cn/post/%E6%B8%B8%E6%88%8F%E7%BC%96%E7%A8%8B%E7%AE%97%E6%B3%95%E4%B8%8E%E6%8A%80%E5%B7%A7%E6%91%84%E5%83%8F%E6%9C%BA%E7%AF%87/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-14T21:58:45+08:00" />
<meta property="article:modified_time" content="2022-01-14T21:58:45+08:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="《游戏编程算法与技巧》摄像机篇"/>
<meta name="twitter:description" content="此篇主要介绍摄像机涵盖的属性和一些摄像机跟随的写法"/>


<meta itemprop="name" content="《游戏编程算法与技巧》摄像机篇">
<meta itemprop="description" content="此篇主要介绍摄像机涵盖的属性和一些摄像机跟随的写法"><meta itemprop="datePublished" content="2022-01-14T21:58:45+08:00" />
<meta itemprop="dateModified" content="2022-01-14T21:58:45+08:00" />
<meta itemprop="wordCount" content="326">
<meta itemprop="keywords" content="《游戏编程算法与技巧》,摄像机," />

<link rel="stylesheet" href="https://sooda.net.cn/css/layout.css" />


<link rel="stylesheet" href="https://sooda.net.cn/css/default-dark.css" />




<title>


     《游戏编程算法与技巧》摄像机篇 

</title>

</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://sooda.net.cn/">Sooda</a>
    </div> 

    
    
    <a class="nav-item" href="https://sooda.net.cn/categories/"><div class="nav-item-title">Categories</div></a>
    
    <a class="nav-item" href="https://sooda.net.cn/tags/"><div class="nav-item-title">Tags</div></a>
    
  </nav>
  <div class="font">
    简简单单生活，安安静静编程
  </div>
  

</div>


</header>


<article class="post">
    <h1 class="title"> 《游戏编程算法与技巧》摄像机篇 </h1>
    <div class="content"> <h1 id="摄像机的基础属性">摄像机的基础属性</h1>
<h2 id="视场">视场</h2>
<p>观看世界的角度和广度，称为视场(FOV)。人双目并视大约能看到120°的视场，而剩余的视场在边缘能够发现运动，但不清晰</p>
<p>如果视场变的太大就会有鱼眼效果，屏幕边缘会弯曲，类似于广角镜头</p>
<h2 id="高宽比">高宽比</h2>
<p>视口的宽度和高度的比率（如4:3、16:9等)</p>
<h1 id="摄像机的跟随实现">摄像机的跟随实现</h1>
<h2 id="基础跟随">基础跟随</h2>
<p>跟随在某个对象后方，保持固定距离，固定的俯视角摄像机</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// tPos: 目标位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// tForward: 目标方向
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// hDist: 水平跟随距离
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// vDist: 垂直跟随距离 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">BasucFollowCamera</span>(GameObject target, <span style="color:#66d9ef">float</span> hDist, <span style="color:#66d9ef">float</span> vDist) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 计算相机位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Vector3 pos <span style="color:#f92672">=</span> target.position <span style="color:#f92672">-</span> target.forward <span style="color:#f92672">*</span> hDist <span style="color:#f92672">+</span> target.up <span style="color:#f92672">*</span> vDist;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 计算相机朝向
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Vector3 cameraForward <span style="color:#f92672">=</span> tPos <span style="color:#f92672">-</span> pos;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置相机位置和朝向
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="弹性跟随相机">弹性跟随相机</h2>
<p>实现相机到相机目标位置的逐渐变化，可以理解为<strong>真实位置的相机</strong>和在基础跟随所要到达的<strong>理想位置</strong>中间有一个弹簧</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpringCamera</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> hDist, vDist;     <span style="color:#75715e">// 水平和垂直跟随距离
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">float</span> springConstant;   <span style="color:#75715e">// 弹性常量：越高弹性越小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">float</span> dampConstant;     <span style="color:#75715e">// 阻尼常量：由弹性常量决定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Vector3 velocity, actualPosition; <span style="color:#75715e">// 速度和摄像机真实位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    GameObject target;      <span style="color:#75715e">// 跟随目标
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>(GameObject _target, <span style="color:#66d9ef">float</span> _springConstant, <span style="color:#66d9ef">float</span> _hDist, <span style="color:#66d9ef">float</span> vDist) {
</span></span><span style="display:flex;"><span>        target <span style="color:#f92672">=</span> _target;
</span></span><span style="display:flex;"><span>        springConstant <span style="color:#f92672">=</span> _springConstant;
</span></span><span style="display:flex;"><span>        hDist <span style="color:#f92672">=</span> _hDist;
</span></span><span style="display:flex;"><span>        vDist <span style="color:#f92672">=</span> _vDist;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 计算阻尼常量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        dampConstant <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.0f</span> <span style="color:#f92672">*</span> sqrt(springConstant);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 最开始真实位置 = 理想位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        actualPosition <span style="color:#f92672">=</span> target.position <span style="color:#f92672">-</span> target.forward <span style="color:#f92672">*</span> hDist <span style="color:#f92672">+</span> target.up <span style="color:#f92672">*</span> vDist;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置相机位置和朝向
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span>(<span style="color:#66d9ef">float</span> deltaTime) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 计算理想位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Vector3 idealPosition <span style="color:#f92672">=</span> target.position <span style="color:#f92672">-</span> target.forward <span style="color:#f92672">*</span> hDist <span style="color:#f92672">+</span> target.up <span style="color:#f92672">*</span> vDist;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 计算理想位置到真实位置的向量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Vector3 displacement <span style="color:#f92672">=</span> actualPosition <span style="color:#f92672">-</span> idealPosition;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 根据弹簧计算加速度，然后积分
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Vector3 springAccel <span style="color:#f92672">=</span> (<span style="color:#f92672">-</span>springConstant <span style="color:#f92672">*</span> displacement) <span style="color:#f92672">-</span> (dampConstant <span style="color:#f92672">*</span> velocity);
</span></span><span style="display:flex;"><span>        velocity <span style="color:#f92672">+=</span> springAccel <span style="color:#f92672">*</span> deltaTime;
</span></span><span style="display:flex;"><span>        actualPosition <span style="color:#f92672">+=</span> velocity <span style="color:#f92672">*</span> deltaTime;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置相机位置和朝向
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="样条摄像机">样条摄像机</h1>
<p>样条可以看作曲线，用线上的点定义的。使用她进行插值能够在整条曲线上得到平滑的效果。</p>
<h2 id="catmull-rom样条">Catmull-Rom样条</h2>
<p>邻近点进行插值。需要四个点，两个在前和后的控制点$P_0$和$P_3$，两个在中间的激活点$P_1$和$P_2$。计算t值介于0到1的所有样条公式(需要在控制点均匀的情况下使用)：</p>
<p>$$
P(t) = 0.5 \cdot (2 \cdot P_1) + (-P_0 + P_2) \cdot t + \newline
(2 \cdot P_0 - 5 \cdot P_1 + 4 \cdot P_2 - P_3) \cdot t^2 + \newline
(-P_0 + 3 \cdot P_1 - 3 \cdot P_2 + P_3) \cdot t^3
$$</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CRSpline</span> {
</span></span><span style="display:flex;"><span>    Vector3[] controlPoints; <span style="color:#75715e">// 样条点的动态数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 计算曲线
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// start: t=0对应的控制点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Vector3 <span style="color:#a6e22e">Compute</span>(<span style="color:#66d9ef">int</span> start, <span style="color:#66d9ef">float</span> t) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 检查start-1，start，start+1和start+2都要存在
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Vector3 P0 <span style="color:#f92672">=</span> controlPoints[start <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>        Vector3 P1 <span style="color:#f92672">=</span> controlPoints[start];
</span></span><span style="display:flex;"><span>        Vector3 P2 <span style="color:#f92672">=</span> controlPoints[start <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>        Vector3 P3 <span style="color:#f92672">=</span> controlPoints[start <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Vector3 position <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span>((<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>P1)<span style="color:#f92672">+</span>(<span style="color:#f92672">-</span>P0<span style="color:#f92672">+</span>P2)<span style="color:#f92672">*</span>t<span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            (<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>P0<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span>P1<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>P2<span style="color:#f92672">-</span>P3)<span style="color:#f92672">*</span>t<span style="color:#f92672">*</span>t<span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            (<span style="color:#f92672">-</span>P0<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>P<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>P2<span style="color:#f92672">+</span>P3)<span style="color:#f92672">*</span>t<span style="color:#f92672">*</span>t<span style="color:#f92672">*</span>t);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> position;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这个公式也可用于计算t介于0到1之间的切线。首先，计算任意的t位置。然后，计算t加很小的增量$\Delta t$的位置。就可以构造一个$p(t)$到$P(t+\Delta t)$的向量并且正规化，从而近似得到切线。为了<strong>表示摄像机的移动方向</strong>。</p>
<h1 id="相机支持算法">相机支持算法</h1>
<h2 id="相机碰撞检测">相机碰撞检测</h2>
<p>为了避免穿墙等问题，最简单的方式就是让从目标位置到相机进行光线检测，碰撞到物体则让相机位置改变到碰撞的物体之前。缺点是变换很突然。也可以用物理的方法做碰撞检测。</p>
<p>让离相机过近的物体进行消失或者淡出，避免穿模。</p>
<h2 id="拣选鼠标点击从相机发射射线">拣选（鼠标点击从相机发射射线）</h2>
<p>鼠标的位置是屏幕空间中的一个2D点。将这个2D点从屏幕空间变换回世界空间去，称之为反投影。反投影为摄像机矩阵乘以投影矩阵的逆矩阵：
$$
unprojection = (camera \times projection)^{-1}
$$
但2D点不能乘以4x4矩阵，所以要线将2D点转换到齐次坐标系。z分量通常设置为0或1，取决于近平面或远平面。而作为一个点，w分量总为1.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Vector3 <span style="color:#a6e22e">Unproject</span>(Vector4 screenPoint, Matrix camera, Matrix projection) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 计算逆矩阵
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Matrix unprojection <span style="color:#f92672">=</span> camera <span style="color:#f92672">*</span> projection;
</span></span><span style="display:flex;"><span>    unprojection.Invert();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> screenPoint <span style="color:#f92672">*</span> unprojection;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div> </div>
    <footer class="post-footer">

  <div class="post-footer-data">
            
<div class="tags">
  
    
      <div class="tag">
        <a href="https://sooda.net.cn/tags/%E6%B8%B8%E6%88%8F%E7%BC%96%E7%A8%8B%E7%AE%97%E6%B3%95%E4%B8%8E%E6%8A%80%E5%B7%A7">#《游戏编程算法与技巧》</a>
      </div>
    
      <div class="tag">
        <a href="https://sooda.net.cn/tags/%E6%91%84%E5%83%8F%E6%9C%BA">#摄像机</a>
      </div>
    
  
</div>

    <div class="date"> 2022-01-14 </div>
    
    <hr>
            
<div class="categories">
  
  Published in:
    
      <div class="category">
        <a href="https://sooda.net.cn/categories/%E9%98%85%E8%AF%BB%E6%8F%90%E7%82%BC">阅读提炼</a>
      </div>
    
  
</div>

            
<div class="series">
  
</div>

    
  </div>
</footer>


  
  



</article>

  <footer>

  <div class="social-links-footer">

  

  
  <a href="https://github.com/yLong765" target="_blank"><div class="social-link">GitHub</div></a>
  

  

  

  

  

</div>


  <div class="copyright"> Copyright © 2022, All Rights Reserved. </div>

  

  </footer>

</div> 

</body>
</html>


<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <title>CSharpSocket和protpBuf新手村教程 - Sooda</title>
  <meta content='CSharpSocket和protpBuf新手村教程 - Sooda' property='title' />
  <meta content='CSharpSocket和protpBuf新手村教程 - Sooda' property='og:title' />


<meta property="og:description" content="Boss-&gt;Socket 此教程纯属Socket初级应用篇，因为网上全是理论篇（实践才是王道） 1级-&gt;Client创建 首先创建一个C#命令行工程（别告诉这个不" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/csharpsocket%E5%92%8Cprotpbuf%E6%96%B0%E6%89%8B%E6%9D%91%E6%95%99%E7%A8%8B/" />


<meta property="article:published_time" content="2019-06-04T23:29:22&#43;08:00"/>

<meta property="article:modified_time" content="2019-06-04T23:29:22&#43;08:00"/>








<meta name="generator" content="Hugo 0.83.1" />

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='/css/tachyons.min.css' rel="stylesheet">
<link href='/css/styles.css' rel="stylesheet">


<link rel="icon" 
 
  href='/favicon.ico'

type="image/x-icon"/>

<link href='/feed.xml' rel="alternate" type="application/atom+xml" title="Sooda" />
</head>
<body class="global-font">
  <nav class=" flex-ns justify-between border-box pa3 pl3-l pr2-l mt1 mt0-ns" id="navbar">
  <div class="flex">
    <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph2 br2" id="site-title" href='/' title="Home">Sooda</a>
  </div>
  
  <div class=" flex-ns mt2 mt0-ns pv1">
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='/' title="首页">首页</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='/posts/' title="归档">归档</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='/tags/' title="标签">标签</a>
    
  </div>
  
</nav>
  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">CSharpSocket和protpBuf新手村教程</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>04 Jun 2019</time> 
     | 
    
    
    tags: [ <a href='/tags/socket' class="link silver">Socket</a> <a href='/tags/protpbuf' class="link silver">ProtpBuf</a>  ]
    
  </p>
  <div class="lh-copy post-content"><h2 id="boss-socket">Boss-&gt;Socket</h2>
<p>此教程纯属Socket初级应用篇，因为网上全是理论篇（实践才是王道）</p>
<h3 id="1级-client创建">1级-&gt;Client创建</h3>
<ol>
<li>
<p>首先创建一个C#命令行工程（别告诉这个不会）</p>
</li>
<li>
<p>创建Socket实例，别忘了引用System.Net和System.Net.Sockets</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">Socket client = <span style="color:#8b008b;font-weight:bold">new</span> Socket(SocketType.Stream, ProtocolType.Tcp); <span style="color:#228b22">// TCP链接
</span></code></pre></div><ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.sockets.socket?redirectedfrom=MSDN&amp;view=netframework-4.8">Socket</a></li>
</ul>
</li>
<li>
<p>设置要链接的服务器ip地址，IPAddress是C#提供的ip封装类</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">IPAddress ip = IPAddress.Parse(<span style="color:#cd5555">&#34;127.0.0.1&#34;</span>); <span style="color:#228b22">// 本地地址127.0.0.1（别说你不知道）
</span></code></pre></div><ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.ipendpoint?redirectedfrom=MSDN&amp;view=netframework-4.8">IPAddress</a></li>
</ul>
</li>
<li>
<p>设置要链接的服务器ip和端口，IPEndPoint是C#提供的ip和端口的封装类</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">IPEndPoint point = <span style="color:#8b008b;font-weight:bold">new</span> IPEndPoint(ip, <span style="color:#b452cd">2333</span>); <span style="color:#228b22">// 端口为2333，ip为上一段代码的ip
</span></code></pre></div></li>
<li>
<p>链接</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">client.Connect(point);
<span style="color:#228b22">// client.Connect(&#34;127.0.0.1&#34;, 2333); // 等同于3,4
</span></code></pre></div></li>
<li>
<p>开启线程接收服务器消息，别忘了引用System.Threading</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">Thread thread = <span style="color:#8b008b;font-weight:bold">new</span> Thread(Recive);
thread.IsBackground = <span style="color:#8b008b;font-weight:bold">true</span>; <span style="color:#228b22">// 后台执行线程
</span><span style="color:#228b22"></span>thread.Start(client); <span style="color:#228b22">// 传入客户端的Socket
</span></code></pre></div><div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#228b22">// Recive函数
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">void</span> Recive(<span style="color:#00688b;font-weight:bold">object</span> o)
{
    <span style="color:#00688b;font-weight:bold">var</span> client = o <span style="color:#8b008b;font-weight:bold">as</span> Socket;
    <span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#8b008b;font-weight:bold">true</span>)
    {
        <span style="color:#00688b;font-weight:bold">byte</span>[] buffer = <span style="color:#8b008b;font-weight:bold">new</span> <span style="color:#00688b;font-weight:bold">byte</span>[<span style="color:#b452cd">1024</span> * <span style="color:#b452cd">1024</span> * <span style="color:#b452cd">2</span>];
        <span style="color:#00688b;font-weight:bold">int</span> effective = client.Receive(buffer); <span style="color:#228b22">//二进制数据存储在buffer中，数据长度为effective
</span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">if</span> (effective == <span style="color:#b452cd">0</span>)
        {
            <span style="color:#8b008b;font-weight:bold">break</span>;
        }
        <span style="color:#00688b;font-weight:bold">var</span> str = Encoding.UTF8.GetString(buffer, <span style="color:#b452cd">0</span>, effective); <span style="color:#228b22">// 将二进制数据转换为UTF8格式的String
</span><span style="color:#228b22"></span>        Console.WriteLine(str);
    }
}
</code></pre></div><ul>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.net.sockets.socket.receive?redirectedfrom=MSDN&amp;view=netframework-4.8#overloads">Recieve函数</a></li>
</ul>
</li>
<li>
<p>发送自定义数据给服务器</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#8b008b;font-weight:bold">true</span>)
{
    <span style="color:#00688b;font-weight:bold">string</span> s = Console.ReadLine();
    <span style="color:#00688b;font-weight:bold">byte</span>[] buffer = Encoding.ASCII.GetBytes(s); <span style="color:#228b22">// 将数据转换为ASCII编码的二进制数组形式
</span><span style="color:#228b22"></span>    socketClient.Send(buffer); <span style="color:#228b22">// 发送消息
</span><span style="color:#228b22"></span>    Console.WriteLine(<span style="color:#cd5555">&#34;Send Message&#34;</span>);
}
</code></pre></div></li>
<li>
<p>client完整代码</p>
</li>
</ol>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System</span>;
<span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System.IO</span>;
<span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System.Net</span>;
<span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System.Net.Sockets</span>;
<span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System.Text</span>;
<span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System.Threading</span>;

<span style="color:#8b008b;font-weight:bold">namespace</span> <span style="color:#008b45;text-decoration:underline">SocketTest</span>
{
    <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">Program</span>
    {
        <span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">void</span> Main(<span style="color:#00688b;font-weight:bold">string</span>[] args)
        {
            Socket client = <span style="color:#8b008b;font-weight:bold">new</span> Socket(SocketType.Stream, ProtocolType.Tcp);
            IPAddress ip = IPAddress.Parse(<span style="color:#cd5555">&#34;127.0.0.1&#34;</span>);
            IPEndPoint point = <span style="color:#8b008b;font-weight:bold">new</span> IPEndPoint(ip, <span style="color:#b452cd">2333</span>);
            client.Connect(<span style="color:#cd5555">&#34;127.0.0.1&#34;</span>, <span style="color:#b452cd">2333</span>);

            Thread thread = <span style="color:#8b008b;font-weight:bold">new</span> Thread(Recive);
            thread.IsBackground = <span style="color:#8b008b;font-weight:bold">true</span>;
            thread.Start(client);

            <span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#8b008b;font-weight:bold">true</span>)
            {
                <span style="color:#00688b;font-weight:bold">string</span> s = Console.ReadLine();
                <span style="color:#00688b;font-weight:bold">byte</span>[] buffer = Encoding.ASCII.GetBytes(s);
                client.Send(buffer);
                Console.WriteLine(<span style="color:#cd5555">&#34;Send Message&#34;</span>);
            }
        }

        <span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">void</span> Recive(<span style="color:#00688b;font-weight:bold">object</span> o)
        {
            <span style="color:#00688b;font-weight:bold">var</span> client = o <span style="color:#8b008b;font-weight:bold">as</span> Socket;
            <span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#8b008b;font-weight:bold">true</span>)
            {
                <span style="color:#00688b;font-weight:bold">byte</span>[] buffer = <span style="color:#8b008b;font-weight:bold">new</span> <span style="color:#00688b;font-weight:bold">byte</span>[<span style="color:#b452cd">1024</span> * <span style="color:#b452cd">1024</span> * <span style="color:#b452cd">2</span>];
                <span style="color:#00688b;font-weight:bold">var</span> effective = client.Receive(buffer);
                <span style="color:#8b008b;font-weight:bold">if</span> (effective == <span style="color:#b452cd">0</span>)
                {
                    <span style="color:#8b008b;font-weight:bold">break</span>;
                }
                <span style="color:#00688b;font-weight:bold">var</span> str = Encoding.UTF8.GetString(buffer, <span style="color:#b452cd">0</span>, effective);
                Console.WriteLine(str);
            }
        }
    }
}
</code></pre></div><h3 id="2级-server创建">2级-&gt;Server创建</h3>
<ol>
<li>
<p>首先创建一个C#命令行工程（别告诉这个不会）</p>
</li>
<li>
<p>创建Socket实例（同client）</p>
</li>
<li>
<p>设置服务器的ip地址</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">IPAddress ip = IPAddress.Parse(<span style="color:#cd5555">&#34;127.0.0.1&#34;</span>);
IPEndPoint point = <span style="color:#8b008b;font-weight:bold">new</span> IPEndPoint(ip, <span style="color:#b452cd">2333</span>);
server.Bind(point);
</code></pre></div></li>
<li>
<p>设置服务器的最大监听数</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">server.Listen(<span style="color:#b452cd">10</span>);
</code></pre></div></li>
<li>
<p>开启线程接收客户端连接和数据（※注意是连接）</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">Thread thread = <span style="color:#8b008b;font-weight:bold">new</span> Thread(Listen);
thread.IsBackground = <span style="color:#8b008b;font-weight:bold">true</span>;
thread.Start(serverSocket);
</code></pre></div><div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#228b22">// Listen函数，等待客户端连接
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">void</span> Listen(<span style="color:#00688b;font-weight:bold">object</span> o)
{
    <span style="color:#00688b;font-weight:bold">var</span> serverSocket = o <span style="color:#8b008b;font-weight:bold">as</span> Socket;
    <span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#8b008b;font-weight:bold">true</span>)
    {
        client = serverSocket.Accept(); <span style="color:#228b22">// 等待客户端连接，返回客户端的Socket，之前的10限制就是在这里，最多有10个客户端可以建立连接
</span><span style="color:#228b22"></span>        <span style="color:#00688b;font-weight:bold">var</span> sendIpoint = client.RemoteEndPoint.ToString(); <span style="color:#228b22">// 客户端的ip和端口
</span><span style="color:#228b22"></span>        Console.WriteLine(<span style="color:#cd5555">$&#34;{sendIpoint}Connection&#34;</span>);
        <span style="color:#228b22">// 连接成功则开启一个接收线程接收客户端发来的消息
</span><span style="color:#228b22"></span>        Thread thread = <span style="color:#8b008b;font-weight:bold">new</span> Thread(Recive);
        thread.IsBackground = <span style="color:#8b008b;font-weight:bold">true</span>;
        thread.Start(client);
    }
}
</code></pre></div><div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#228b22">// Recive函数，同客户端
</span></code></pre></div></li>
<li>
<p>server完整代码</p>
</li>
</ol>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System</span>;
<span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System.Net</span>;
<span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System.Net.Sockets</span>;
<span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System.Text</span>;
<span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#008b45;text-decoration:underline">System.Threading</span>;

<span style="color:#8b008b;font-weight:bold">namespace</span> <span style="color:#008b45;text-decoration:underline">SocketServer</span>
{
    <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">Program</span>
    {
        <span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">void</span> Main(<span style="color:#00688b;font-weight:bold">string</span>[] args)
        {
            Socket server = <span style="color:#8b008b;font-weight:bold">new</span> Socket(SocketType.Stream, ProtocolType.Tcp);
            IPAddress ip = IPAddress.Parse(<span style="color:#cd5555">&#34;127.0.0.1&#34;</span>);
            IPEndPoint point = <span style="color:#8b008b;font-weight:bold">new</span> IPEndPoint(ip, <span style="color:#b452cd">2333</span>);
            server.Bind(point);
            server.Listen(<span style="color:#b452cd">10</span>);

            Thread thread = <span style="color:#8b008b;font-weight:bold">new</span> Thread(Listen);
            thread.IsBackground = <span style="color:#8b008b;font-weight:bold">true</span>;
            thread.Start(server);

            Console.Read();
        }

        <span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">void</span> Listen(<span style="color:#00688b;font-weight:bold">object</span> o)
        {
            <span style="color:#00688b;font-weight:bold">var</span> server = o <span style="color:#8b008b;font-weight:bold">as</span> Socket;
            <span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#8b008b;font-weight:bold">true</span>)
            {
                client = server.Accept();
                <span style="color:#00688b;font-weight:bold">var</span> clientIpoint = client.RemoteEndPoint.ToString();
                Console.WriteLine(<span style="color:#cd5555">$&#34;{clientIpoint}Connection&#34;</span>);
                Thread thread = <span style="color:#8b008b;font-weight:bold">new</span> Thread(Recive);
                thread.IsBackground = <span style="color:#8b008b;font-weight:bold">true</span>;
                thread.Start(client);
            }
        }

        <span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">void</span> Recive(<span style="color:#00688b;font-weight:bold">object</span> o)
        {
            <span style="color:#00688b;font-weight:bold">var</span> client = o <span style="color:#8b008b;font-weight:bold">as</span> Socket;
            <span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#8b008b;font-weight:bold">true</span>)
            {
                <span style="color:#00688b;font-weight:bold">byte</span>[] buffer = <span style="color:#8b008b;font-weight:bold">new</span> <span style="color:#00688b;font-weight:bold">byte</span>[<span style="color:#b452cd">1024</span> * <span style="color:#b452cd">1024</span> * <span style="color:#b452cd">2</span>];
                <span style="color:#00688b;font-weight:bold">var</span> effective = client.Receive(buffer);
                <span style="color:#8b008b;font-weight:bold">if</span> (effective == <span style="color:#b452cd">0</span>)
                {
                    <span style="color:#8b008b;font-weight:bold">break</span>;
                }
                <span style="color:#00688b;font-weight:bold">var</span> str = Encoding.UTF8.GetString(buffer, <span style="color:#b452cd">0</span>, effective);
                Console.WriteLine(str);
            }
        }
    }
}
</code></pre></div><h2 id="boss-protobuf">Boss-&gt;ProtoBuf</h2>
<p>如果我们要用ProtoBuf用在C#中就得集齐各种神器</p>
<ol>
<li><a href="https://github.com/protocolbuffers/protobuf/tree/v3.8.0">ProtoBuf源码</a>：其中有C#的示例代码</li>
<li><a href="https://github.com/protocolbuffers/protobuf/releases/tag/v3.8.0">ProtoBuf编译器</a>：编译<code>.proto</code>文件</li>
<li><a href="https://www.nuget.org/packages/Google.Protobuf/3.8.0">ProtoBuf的C#工具集</a>(你可能会需要下载nuget)：提供工程中的dll引用文件</li>
<li><a href="https://developers.google.com/protocol-buffers/">ProtoBuf官方教程</a>(科学上网)</li>
</ol>
<h3 id="1级-编写proto文件">1级-&gt;编写proto文件</h3>
<p>都说ProtoBuf不依赖于任何语言是一个跨语言的神器，然而他的语言格式是scheme(Lisp的方言)，并且编译器就是把<code>.proto</code>文件翻译成各个不同语言的编译器。</p>
<p>proto文件示例(教程中示例的文件)</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#228b22">// [START declaration]
</span><span style="color:#228b22"></span>syntax = <span style="color:#cd5555">&#34;proto3&#34;</span>;
package tutorial;

import <span style="color:#cd5555">&#34;google/protobuf/timestamp.proto&#34;</span>;
<span style="color:#228b22">// [END declaration]
</span><span style="color:#228b22"></span>
<span style="color:#228b22">// [START java_declaration]
</span><span style="color:#228b22"></span>option java_package = <span style="color:#cd5555">&#34;com.example.tutorial&#34;</span>;
option java_outer_classname = <span style="color:#cd5555">&#34;AddressBookProtos&#34;</span>;
<span style="color:#228b22">// [END java_declaration]
</span><span style="color:#228b22"></span>
<span style="color:#228b22">// [START csharp_declaration]
</span><span style="color:#228b22"></span>option csharp_namespace = <span style="color:#cd5555">&#34;Google.Protobuf.Examples.AddressBook&#34;</span>;
<span style="color:#228b22">// [END csharp_declaration]
</span><span style="color:#228b22"></span>
<span style="color:#228b22">// [START messages]
</span><span style="color:#228b22"></span>message Person {
  <span style="color:#00688b;font-weight:bold">string</span> name = <span style="color:#b452cd">1</span>;
  int32 id = <span style="color:#b452cd">2</span>;  <span style="color:#228b22">// Unique ID number for this person.
</span><span style="color:#228b22"></span>  <span style="color:#00688b;font-weight:bold">string</span> email = <span style="color:#b452cd">3</span>;

  <span style="color:#8b008b;font-weight:bold">enum</span> PhoneType {
    MOBILE = <span style="color:#b452cd">0</span>;
    HOME = <span style="color:#b452cd">1</span>;
    WORK = <span style="color:#b452cd">2</span>;
  }

  message PhoneNumber {
    <span style="color:#00688b;font-weight:bold">string</span> number = <span style="color:#b452cd">1</span>;
    PhoneType type = <span style="color:#b452cd">2</span>;
  }

  repeated PhoneNumber phones = <span style="color:#b452cd">4</span>;

  google.protobuf.Timestamp last_updated = <span style="color:#b452cd">5</span>;
}

<span style="color:#228b22">// Our address book file is just one of these.
</span><span style="color:#228b22"></span>message AddressBook {
  repeated Person people = <span style="color:#b452cd">1</span>;
}
<span style="color:#228b22">// [END messages]
</span></code></pre></div><h3 id="2级-编译proto文件">2级-&gt;编译proto文件</h3>
<p>将上面的文件用proto.exe编译</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a61717;background-color:#e3d2d2">格式：</span>proto -I=<span style="color:#a61717;background-color:#e3d2d2">当前目录</span> -out_csharp=<span style="color:#a61717;background-color:#e3d2d2">当前目录</span> <span style="color:#a61717;background-color:#e3d2d2">目录</span>/<span style="color:#a61717;background-color:#e3d2d2">文件名</span>.<span style="color:#a61717;background-color:#e3d2d2">扩展名</span>
<span style="color:#a61717;background-color:#e3d2d2">例：</span>
<span style="color:#a61717;background-color:#e3d2d2">文件名为：</span>address.proto
<span style="color:#a61717;background-color:#e3d2d2">目录为：</span>D:/Work下
proto -I=D:/Work -out_csharp=D:/Work D:/Wrok/address.proto
</code></pre></div><p>编译完后会生成一个<code>.cs</code>文件，文件很长我就不展示了</p>
<h3 id="3级-nuget下载dll">3级-&gt;nuget下载dll</h3>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">nuget install Google.Protobuf -Version <span style="color:#b452cd">3.8</span>.<span style="color:#b452cd">0</span> <span style="color:#228b22">// 版本随意
</span></code></pre></div><p>下载下来找到dll</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">Google.Protobuf.<span style="color:#b452cd">3.8</span>.<span style="color:#b452cd">0</span>/bin/net45/Google.Protobuf.dll
</code></pre></div><p>引用到客户端和服务器中，然后把生成的<code>.cs</code>文件也复制到项目中</p>
<h3 id="4级-编写序列化和反序列化代码">4级-&gt;编写序列化和反序列化代码</h3>
<p>在客户端和服务器的Program（上面的代码）中加入序列化和反序列化的函数，需要引用Google.Protobuf、Google.Protobuf.Examples.AddressBook和static Google.Protobuf.Examples.AddressBook.Person.Types(C#6 才支持)</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">byte</span>[] Serialize&lt;T&gt;(T obj) <span style="color:#8b008b;font-weight:bold">where</span> T : IMessage
{
    <span style="color:#8b008b;font-weight:bold">return</span> obj.ToByteArray();
}

<span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">static</span> T Deserialize&lt;T&gt;(<span style="color:#00688b;font-weight:bold">byte</span>[] data) <span style="color:#8b008b;font-weight:bold">where</span> T : class, IMessage, <span style="color:#8b008b;font-weight:bold">new</span>()
{
    T obj = <span style="color:#8b008b;font-weight:bold">new</span> T();
    IMessage message = obj.Descriptor.Parser.ParseFrom(data);
    <span style="color:#8b008b;font-weight:bold">return</span> message <span style="color:#8b008b;font-weight:bold">as</span> T;
}
</code></pre></div><p>注释：</p>
<ol>
<li>可以看到由<code>.proto</code>转换成<code>.cs</code>的文件的父接口为IMessage</li>
<li>ToByteArray()是protoBuf自带的类转二进制的函数（所谓的序列化）</li>
<li>obj.Descriptor.Parser.ParseFrom是是protoBuf自带的二进制转类的函数（所谓的反序列化）</li>
</ol>
<p>知道这些之后就可以传输二进制数据啦，所以我们的客户端代码的发送数据部分改为</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#228b22">// 建立数据
</span><span style="color:#228b22"></span>Person john = <span style="color:#8b008b;font-weight:bold">new</span> Person
{
    Id = <span style="color:#b452cd">1234</span>,
    Name = <span style="color:#cd5555">&#34;John Doe&#34;</span>,
    Email = <span style="color:#cd5555">&#34;jdoe@example.com&#34;</span>,
    Phones = { <span style="color:#8b008b;font-weight:bold">new</span> PhoneNumber { Number = <span style="color:#cd5555">&#34;555-4321&#34;</span>, Type = PhoneType.Home } }
};
<span style="color:#00688b;font-weight:bold">var</span> message = Serialize(john); <span style="color:#228b22">// 得到byte[]的message
</span><span style="color:#228b22"></span>
<span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#8b008b;font-weight:bold">true</span>)
{
    <span style="color:#00688b;font-weight:bold">string</span> s = Console.ReadLine();
    socketClient.Send(message); <span style="color:#228b22">//  直接传输message
</span><span style="color:#228b22"></span>    Console.WriteLine(<span style="color:#cd5555">&#34;Send Message&#34;</span>);
}
</code></pre></div><p>服务端的接受部分改一下，这部分注意反序列化素组的长度必须和序列化后的一致，所以这边新建了一个正确长度的b2数组把数据复制过去</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">void</span> Recive(<span style="color:#00688b;font-weight:bold">object</span> o)
{
    <span style="color:#00688b;font-weight:bold">var</span> send = o <span style="color:#8b008b;font-weight:bold">as</span> Socket;
    <span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#8b008b;font-weight:bold">true</span>)
    {
        <span style="color:#00688b;font-weight:bold">byte</span>[] buffer = <span style="color:#8b008b;font-weight:bold">new</span> <span style="color:#00688b;font-weight:bold">byte</span>[<span style="color:#b452cd">1024</span> * <span style="color:#b452cd">1024</span> * <span style="color:#b452cd">2</span>];
        <span style="color:#00688b;font-weight:bold">var</span> effective = send.Receive(buffer);
        <span style="color:#00688b;font-weight:bold">byte</span>[] b2 = <span style="color:#8b008b;font-weight:bold">new</span> <span style="color:#00688b;font-weight:bold">byte</span>[effective];
        Array.Copy(buffer, <span style="color:#b452cd">0</span>, b2, <span style="color:#b452cd">0</span>, effective); <span style="color:#228b22">// 把数据拷贝给b2
</span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">if</span> (effective == <span style="color:#b452cd">0</span>)
        {
            <span style="color:#8b008b;font-weight:bold">break</span>;
        }
        <span style="color:#00688b;font-weight:bold">var</span> message = Deserialize&lt;Person&gt;(b2); <span style="color:#228b22">// 解析时候必须为正确的长度
</span><span style="color:#228b22"></span>        Console.WriteLine(<span style="color:#cd5555">&#34;ID = {0}&#34;</span>, message.Id);
        Console.WriteLine(<span style="color:#cd5555">&#34;Name = {0}&#34;</span>, message.Name);
        Console.WriteLine(<span style="color:#cd5555">&#34;Email = {0}&#34;</span>, message.Email);
        Console.WriteLine(<span style="color:#cd5555">&#34;Phone Number = {0}&#34;</span>, message.Phones[<span style="color:#b452cd">0</span>].Number);
        Console.WriteLine(<span style="color:#cd5555">&#34;Phone Type = {0}&#34;</span>, message.Phones[<span style="color:#b452cd">0</span>].Type);
    }
}
</code></pre></div><p>完结撒花~</p>
</div>
</main>
 








<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="http://localhost:1313/posts/%E5%88%A4%E6%96%AD%E7%82%B9%E5%9C%A8%E5%A4%9A%E8%BE%B9%E5%BD%A2%E5%86%85%E9%83%A8/">prev post</a>
  
  </p>
</div>

  <footer class="content-width mt0 mt5-l mb4 f6 center ph3 gray tc tl-l">
  <hr class="dn db-l ml0-l gray w3"><br>
  Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme. <br>
  
</footer>
  






<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}







</script>




</body>
</html>